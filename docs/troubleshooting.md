# トラブルシューティング

このドキュメントでは、Miro-Redmine Integrationの使用中に発生する可能性のある一般的な問題と、その解決方法について説明します。

## エラーコード一覧表

以下は、Miro-Redmine Integrationで発生する可能性のあるエラーコードとその対処方法の一覧です：

| エラーコード | 説明 | 考えられる原因 | 対処方法 |
|------------|------|--------------|---------|
| **RED-001** | Redmine API 接続エラー | APIキーが無効、URLが間違っている | APIキーとURLを確認し、Redmineサーバーが稼働しているか確認 |
| **RED-002** | Redmine プロジェクト取得エラー | プロジェクトIDが間違っている、権限不足 | プロジェクトIDと権限を確認 |
| **RED-003** | Redmine チケット作成エラー | 必須フィールドの欠如、権限不足 | 必須フィールドが設定されているか確認、権限を確認 |
| **RED-004** | Redmine チケット更新エラー | チケットIDが間違っている、権限不足 | チケットIDと権限を確認 |
| **RED-005** | Redmine ステータス変更エラー | 無効なステータス遷移、権限不足 | ステータスワークフローと権限を確認 |
| **MIR-001** | Miro 認証エラー | トークンの期限切れ、無効な認証情報 | 再認証を実行 |
| **MIR-002** | Miro ボード取得エラー | ボードIDが間違っている、権限不足 | ボードIDと権限を確認 |
| **MIR-003** | Miro カード作成エラー | API制限、権限不足 | APIリクエスト数を確認、権限を確認 |
| **MIR-004** | Miro カード更新エラー | カードIDが間違っている、権限不足 | カードIDと権限を確認 |
| **SYN-001** | 同期初期化エラー | 設定ファイルの問題、接続エラー | 設定ファイルを確認、ネットワーク接続を確認 |
| **SYN-002** | 同期処理タイムアウト | 大量のチケット、サーバー負荷 | バッチサイズを小さくする、サーバーリソースを増加 |
| **SYN-003** | マッピング保存エラー | ファイル権限の問題、ディスクスペース不足 | ファイル権限とディスクスペースを確認 |
| **WHK-001** | Webhook 受信エラー | 設定の問題、URLの誤り | Webhookの設定を確認 |
| **WHK-002** | Webhook 検証エラー | シークレットの不一致、改ざんされたリクエスト | Webhookシークレットを確認 |
| **WHK-003** | Webhook 処理エラー | データ形式の問題、ハンドラーの不備 | Webhookデータ形式を確認 |
| **CFG-001** | 設定ファイル読み込みエラー | JSONフォーマットエラー、ファイル権限 | 設定ファイルの構文を確認、権限を確認 |
| **CFG-002** | 必須設定不足エラー | 必要な設定パラメータがない | 設定ファイルに必要なパラメータを追加 |
| **DB-001** | データベース接続エラー | 接続情報の誤り、DBサーバーダウン | 接続情報を確認、DBサーバーの状態を確認 |
| **DB-002** | データベースクエリエラー | SQLの誤り、テーブル不在 | SQLクエリを確認、DBスキーマを確認 |
| **SRV-001** | サーバー起動エラー | ポート競合、権限不足 | 使用ポートを変更、適切な権限で実行 |
| **SRV-002** | サーバー内部エラー | 未処理の例外、リソース不足 | ログを確認、サーバーリソースを増加 |

## 診断フローチャート

問題が発生した場合は、以下の診断フローを使用して原因を特定し、解決してください：

![診断フローチャート](images/troubleshooting-flowchart.png)

### 同期エラーの診断フロー

1. **アプリケーションログの確認**
   * ログファイルでエラーメッセージを特定
   * エラーコードが存在する場合は上記の表を参照

2. **接続状態の確認**
   * Redmine接続テストの実行
   * Miro接続テストの実行
   * ネットワーク接続の確認

3. **データの確認**
   * 同期しようとしているチケットの状態を確認
   * 特殊文字や長すぎるテキストがないか確認

4. **権限の確認**
   * RedmineのAPI権限設定
   * MiroのOAuth権限スコープ
   * サーバーのファイル権限

5. **最終手段**
   * 設定ファイルのバックアップを取得
   * アプリケーションの再インストール
   * データベース（使用している場合）のリセット

## よくある質問（FAQ）

### 一般的な質問

#### Q: Miro-Redmine Integrationは無料で使用できますか？
A: 本ツールはオープンソースで提供されており、ソフトウェア自体は無料です。ただし、MiroとRedmineのアカウントは別途必要であり、Miroは有料プラン（Professional以上推奨）が必要です。

#### Q: どのブラウザでMiro-Redmine Integrationを使用できますか？
A: Chrome、Firefox、Edge、Safariの最新バージョンでテスト済みです。Internet Explorerはサポートしていません。

#### Q: 複数のRedmineプロジェクトを1つのMiroボードに連携できますか？
A: はい、可能です。設定ファイルで複数のプロジェクトを配置するY座標オフセットを指定することで、1つのボードに複数のプロジェクトを表示できます。

### インストールと設定

#### Q: インストール時に「Node.jsバージョンエラー」が表示されます。
A: このツールはNode.js 14.x以上が必要です。`node -v`コマンドでバージョンを確認し、必要に応じて最新バージョンをインストールしてください。

#### Q: Miroの認証が成功しても、すぐに期限切れになります。
A: Miroのアクセストークンの有効期限は通常14日間です。設定ファイルで`refreshToken`オプションを有効にすると、トークンが自動的に更新されます。

#### Q: WebhookのURLはどのように設定すればよいですか？
A: Webhookの完全なURLは `http(s)://あなたのサーバー:ポート/api/webhooks/redmine` または `/api/webhooks/miro` となります。インターネットからアクセス可能なURLである必要があります。

### 運用と使用方法

#### Q: 同期頻度はどのくらいに設定すべきですか？
A: リアルタイム性が重要な場合はWebhookを使用し、それ以外の場合は5〜15分間隔の定期同期をお勧めします。チケット数が多い場合は、同期間隔を長めに設定してください。

#### Q: Miroボードのレイアウトを変更すると、同期が壊れますか？
A: カラムの位置を大幅に変更した場合は、設定ファイルの`statusMapping`セクションも更新する必要があります。小さな調整であれば問題ありません。

#### Q: チケットの添付ファイルはMiroボードに表示されますか？
A: 基本設定では添付ファイルは同期されません。設定ファイルで`syncAttachments`オプションを有効にすると、画像添付ファイルはカードにサムネイルとして表示されます。

### エラーと問題解決

#### Q: 「SYN-002」エラー（同期タイムアウト）が頻繁に発生します。
A: 大量のチケットがある場合に発生します。設定ファイルの`syncBatchSize`の値を小さくするか、`syncTimeout`の値を大きくしてください。

#### Q: ドラッグ＆ドロップ操作がRedmineに反映されません。
A: 以下を確認してください：
1. Miroウェブフックが正しく設定されていること
2. カードのメタデータにRedmineチケットIDが含まれていること
3. ブラウザコンソールでJavaScriptエラーがないこと

#### Q: カードの色やラベルがチケットの状態と一致しません。
A: スタイル設定を確認し、設定ファイルの`styleMapping`セクションを更新してください。また、最新の状態を反映するために手動同期を実行してみてください。

## 追加のトラブルシューティング情報

### ログファイルの場所

問題診断には詳細なログが役立ちます。ログファイルは以下の場所にあります：

- **Linux/Mac**: `/var/log/miro-redmine/` または `/opt/miro-redmine/logs/`
- **Windows**: `C:\ProgramData\miro-redmine\logs\` 
- **Docker**: コンテナ内の `/app/logs/` ディレクトリ（`docker exec -it コンテナID ls -la /app/logs` で確認可能）

### ログレベルの変更

より詳細なログを取得するには、設定ファイルで`logLevel`を`debug`に変更します：

```json
{
  "logging": {
    "level": "debug",
    "file": "logs/app.log"
  }
}
```

### データリセット

同期状態を完全にリセットする必要がある場合：

1. アプリケーションを停止します
2. データディレクトリ内の `sync-state.json` ファイルを削除します
3. データベースを使用している場合は、関連テーブルをトランケートします
4. アプリケーションを再起動し、初期同期を実行します

## フィードバックとサポート

より詳細なサポートが必要な場合や、バグを報告したい場合は：

1. GitHubリポジトリのIssueセクションで新しい問題を作成してください
2. 問題の詳細、発生状況、エラーメッセージを記入してください
3. ログファイルがあれば添付してください（機密情報は削除してください）

## 一般的なエラーメッセージと解決策

### "Cannot read property 'id' of undefined"

**発生状況**: チケット同期中に発生することが多い

**解決策**:
1. Redmine APIからの応答を確認してください
2. チケットが実際に存在することを確認してください
3. チケットにアクセスする権限があることを確認してください

### "Error: Request failed with status code 429"

**発生状況**: API制限に達した場合

**解決策**:
1. 同期頻度を下げてください
2. バッチサイズを小さくしてください
3. しばらく待ってから再試行してください

### "TypeError: Cannot read property 'access_token' of null"

**発生状況**: Miro認証情報がない、または無効な場合

**解決策**:
1. 管理画面から再認証を行ってください
2. 設定ファイルのMiro認証情報を確認してください
3. Miroデベロッパーポータルでアプリケーションの状態を確認してください
