# トラブルシューティング

このドキュメントでは、Miro-Redmine Integrationの使用中に発生する可能性のある一般的な問題と、その解決方法について説明します。

## 接続・認証の問題

### Redmine APIに接続できない

**症状:**
- 「Redmine APIに接続できません」というエラーメッセージ
- 認証エラーが管理画面に表示される

**考えられる原因と解決策:**

1. **API キーが無効**
   - Redmineの「マイアカウント」ページで新しいAPIキーを生成してください
   - 設定ファイル（`config.json`）のAPIキーを更新してください

2. **Redmine URL が間違っている**
   - URLが正しいか確認してください（例: `https://your-redmine-instance.com`）
   - URLの最後にスラッシュ（`/`）がある場合は削除してください

3. **Redmine APIが有効になっていない**
   - Redmine管理画面で API の有効化を確認してください：
     - 「管理」→「設定」→「API」
     - 「RESTによるWebサービスを有効にする」にチェックが入っていることを確認

4. **ネットワーク問題**
   - サーバーからRedmineへの接続を確認してください
   - ファイアウォール設定を確認してください
   - プロキシ設定が必要な場合は、設定ファイルに追加してください

### Miro APIに接続できない

**症状:**
- 「Miro APIに接続できません」というエラーメッセージ
- Miroボードが読み込めない

**考えられる原因と解決策:**

1. **アクセストークンが無効または期限切れ**
   - Miro-Redmine Integration管理画面の「設定」タブから認証を再実行してください
   - 新しいOAuth認証フローを開始し、新しいアクセストークンを取得してください

2. **クライアントIDまたはシークレットが間違っている**
   - Miroデベロッパーポータルで正しい情報を確認してください
   - 設定ファイル（`config.json`）の値を更新してください

3. **ボードIDが間違っている**
   - MiroボードのURLからボードIDを確認してください（例: `https://miro.com/app/board/o9J_lK2EPpQ=/`の`o9J_lK2EPpQ=`部分）
   - 設定ファイルの`boardId`値を更新してください

4. **必要な権限が不足している**
   - Miroデベロッパーポータルで、アプリケーションに必要な権限（boards:read, boards:write）が付与されていることを確認してください

## 同期の問題

### 同期が一方向にしか動作しない

**症状:**
- RedmineからMiroへの同期は機能するが、その逆は機能しない（またはその逆）

**考えられる原因と解決策:**

1. **ウェブフックの設定ミス**
   - Redmineウェブフックプラグインが正しくインストールされ、設定されていることを確認してください
   - Miroウェブフックの設定を確認してください

2. **ステータスマッピングの問題**
   - 設定ファイルでの`statusMapping`の設定を確認してください
   - Redmineのステータス値とMiroのカラムが正しく対応しているか確認してください

3. **権限の問題**
   - RedmineとMiroの両方で、適切な権限があることを確認してください

### 一部のチケットが同期されない

**症状:**
- 特定のチケットだけが同期されない
- 新しいチケットが同期されない

**考えられる原因と解決策:**

1. **フィルター設定による制限**
   - 設定ファイルで同期対象のフィルター設定を確認してください
   - 「管理画面」→「フィルター設定」で同期対象を確認・修正してください

2. **チケットタイプの問題**
   - 非対応のチケットタイプ（カスタムトラッカーなど）がないか確認してください

3. **データの欠損や形式の問題**
   - 同期できないチケットの詳細を確認し、通常と異なるフィールド値がないか確認してください
   - チケットサイズが大きすぎる場合は、分割することを検討してください

### 同期プロセスが停止する

**症状:**
- 同期が開始されるが途中で停止する
- タイムアウトエラーが表示される

**考えられる原因と解決策:**

1. **大量のチケットデータ**
   - 設定ファイルでバッチサイズを小さくし、一度に処理するチケット数を減らしてください
   - インクリメンタル同期を使用して、変更されたチケットのみを同期するように設定してください

2. **タイムアウト設定**
   - サーバーのタイムアウト設定を延長してください
   - 大規模なプロジェクトの場合は、部分的な同期スケジュールを設定してください

3. **メモリ不足**
   - サーバーのメモリ割り当てを増やしてください
   - 大規模なプロジェクトでは、サーバースペックを向上させてください

## ビジュアル表示の問題

### チケットカードが正しく表示されない

**症状:**
- Miroボード上のカードのレイアウトが崩れる
- 情報が欠けている

**考えられる原因と解決策:**

1. **テンプレートの問題**
   - カードテンプレートの設定を確認してください
   - テンプレート内のフィールド名が正しいか確認してください

2. **長いテキストコンテンツ**
   - 長いテキストが含まれるチケットの場合、表示を簡略化するよう設定を調整してください
   - カード表示の最大文字数を設定してください

3. **特殊文字の問題**
   - HTMLやMD形式の特殊文字が含まれていないか確認してください
   - 必要に応じてテキストエンコーディングの設定を調整してください

### カラムの配置が乱れる

**症状:**
- カードがランダムな位置に表示される
- カラムの区分が明確でない

**考えられる原因と解決策:**

1. **レイアウト設定の問題**
   - ボードレイアウト設定を確認してください
   - カラム位置の座標設定を調整してください

2. **ボードの変更が反映されていない**
   - ボードレイアウトを変更した場合は、設定ファイルも更新してください
   - 「ボード同期」機能を実行して、最新のレイアウトを反映させてください

3. **多すぎるアイテム**
   - ボード上のアイテム数が多い場合は、完了チケットのアーカイブを検討してください
   - フィルター機能を使用して、関連するチケットのみを表示するように設定してください

## パフォーマンスの問題

### アプリケーション全体が遅い

**症状:**
- 画面の読み込みが遅い
- 操作に対するレスポンスが悪い

**考えられる原因と解決策:**

1. **サーバーリソースの不足**
   - サーバーのCPUとメモリ使用率を確認してください
   - 必要に応じてサーバースペックを向上させてください

2. **データベースの最適化**
   - データベースのインデックスを確認してください
   - 定期的なデータベースメンテナンスを行ってください

3. **キャッシュの問題**
   - キャッシュクリアを実行してください
   - キャッシュ設定を最適化してください

### 同期処理が遅い

**症状:**
- 同期完了までに長時間かかる
- APIリクエスト回数が多すぎる警告

**考えられる原因と解決策:**

1. **非効率な同期方法**
   - 増分同期（変更されたチケットのみ）を使用するよう設定してください
   - バッチ処理を最適化してください

2. **APIレート制限**
   - APIコール間の遅延時間を増やしてください
   - バッチサイズを小さくして、一度のリクエストで処理するデータ量を減らしてください

3. **ネットワークの問題**
   - ネットワーク接続速度と信頼性を確認してください
   - Miro-Redmine Integration サーバーとAPI接続先サーバーの地理的な距離を考慮してください

## ログと診断

問題の解決に役立つログと診断情報の取得方法：

1. **アプリケーションログの確認**
   - ログファイルは通常 `logs/` ディレクトリにあります
   - エラーメッセージを確認してください

2. **詳細ログの有効化**
   - 設定ファイルで `logLevel` を `debug` に設定してください
   - 再現テストを実行し、詳細なログを収集してください

3. **API通信のトレース**
   - 開発モードで実行している場合、APIリクエスト/レスポンスのログが記録されます
   - ネットワークモニタリングツールを使用して通信を分析してください

4. **ヘルスチェック診断**
   - 管理画面の「診断」タブでヘルスチェックを実行してください
   - 全てのコンポーネントの状態を確認してください

## その他の一般的な問題

### インストール後に403エラー

**症状:**
- 管理画面にアクセスすると403 Forbiddenエラーが表示される

**解決策:**
- 正しい認証情報でログインしているか確認してください
- サーバーのファイルおよびディレクトリの権限を確認してください

### ウェブフックの設定方法がわからない

**症状:**
- ウェブフックを設定しようとするが、正しい方法がわからない

**解決策:**
- Redmine側のウェブフック設定は、Redmineプラグインの説明を参照してください
- Miro側のウェブフック設定は、[board-setup.md](board-setup.md)のウェブフック設定セクションを参照してください

### アップデート後の互換性問題

**症状:**
- バージョンアップデート後に機能が正常に動作しない

**解決策:**
- 設定ファイルの互換性を確認してください
- マイグレーションスクリプトを実行してデータ構造を更新してください
- 最新のドキュメントを参照して、変更された機能を確認してください

## 問題が解決しない場合

上記の解決策を試しても問題が解決しない場合：

1. GitHubのIssueを確認し、類似の問題がないか探してください
2. 新しいIssueを作成し、以下の情報を含めてください：
   - 発生している問題の詳細な説明
   - 環境情報（OS、ブラウザ、Redmineバージョン、Miroプラン）
   - エラーメッセージやスクリーンショット
   - 問題の再現手順
3. 開発チームからの返信を待ってください

## 追加事例

以下は、特定のユースケースにおける問題と解決策です：

### ケース1: 大規模プロジェクトでの同期問題

大規模プロジェクト（1000チケット以上）では、同期時間が長くなったり、タイムアウトが発生する場合があります。

**解決策:**
- プロジェクトを複数のサブプロジェクトに分割してください
- フィルター設定を使用して、アクティブなチケットのみを同期するように設定してください
- バッチ処理サイズを小さく設定してください（50-100チケット/バッチ推奨）

### ケース2: カスタムフィールドの同期問題

Redmineのカスタムフィールドが正しくMiroボードに反映されない場合があります。

**解決策:**
- カスタムフィールドの設定を確認してください
- テンプレートにカスタムフィールドの変数が正しく設定されているか確認してください
- APIレスポンスでカスタムフィールドの値が正しく返されているか確認してください

### ケース3: マルチプロジェクト環境での使用

複数のRedmineプロジェクトとMiroボードを連携させたい場合があります。

**解決策:**
- 各プロジェクト用に個別の設定ファイルとインスタンスを設定してください
- または、マルチプロジェクトモードを有効にし、プロジェクトマッピング設定を行ってください
- 同時に同期するプロジェクト数に制限を設けてください
